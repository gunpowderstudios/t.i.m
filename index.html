<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">T.I.M â€” Tinnitus Is Manageable</title>
  <meta name="description" content="T.I.M â€” a simple refocus button to support tinnitus habituation. Offline, private, and lightweight." />
  <style>
    :root{
      --bg:#0b0f14; --card:#121826; --text:#e8eef7; --muted:#9fb0c7;
      --accent:#e11d48; --accent2:#be123c; --good:#22c55e; --line:rgba(255,255,255,.09);
    }
    *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 800px at 50% -10%, #1b2a46 0%, var(--bg) 55%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:18px;
    }
    .wrap{ width:min(1020px, 100%); display:grid; gap:16px; grid-template-columns: 1.15fr 0.85fr; }
    @media (max-width: 920px){ .wrap{ grid-template-columns:1fr; } }
    .card{
      background:rgba(18,24,38,.92); border:1px solid var(--line);
      border-radius:18px; padding:18px; box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    h1{ margin:0 0 6px; font-size:22px; letter-spacing:.2px; }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:14px; line-height:1.4; }
    .titleRow{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .tag{ padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px; }
    .button{
      width:100%; aspect-ratio: 2.0/1; border-radius:26px; border:0; cursor:pointer;
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent2) 100%);
      box-shadow: 0 12px 0 rgba(0,0,0,.25), 0 28px 60px rgba(225,29,72,.20);
      color:white; font-size:28px; font-weight:850; letter-spacing:.4px;
      display:flex; align-items:center; justify-content:center; gap:10px; user-select:none;
    }
    .button:active{ transform: translateY(6px); box-shadow: 0 6px 0 rgba(0,0,0,.25), 0 16px 40px rgba(225,29,72,.15); }
    .prompt{
      margin-top:14px; padding:14px; border-radius:14px;
      background: rgba(255,255,255,.06); border:1px solid var(--line);
      min-height:92px; display:flex; align-items:center;
      font-size:18px; line-height:1.35;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px; }
    .pill{
      padding:8px 10px; border-radius:999px; background: rgba(255,255,255,.06);
      border:1px solid var(--line); color:var(--muted); font-size:13px;
      display:flex; align-items:center; gap:8px;
    }
    .toggle{ display:flex; gap:8px; align-items:center; cursor:pointer; user-select:none; }
    input[type="checkbox"]{ width:18px; height:18px; }
    .smallbtn{
      border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06);
      color:var(--text); padding:9px 12px; border-radius:12px; cursor:pointer; font-weight:700;
    }
    .smallbtn:hover{ background: rgba(255,255,255,.09); }
    .kpi{ display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    .box{ padding:12px; border-radius:14px; background: rgba(255,255,255,.06); border:1px solid var(--line); }
    .num{ font-size:22px; font-weight:900; margin:0; }
    .lbl{ margin:2px 0 0; color:var(--muted); font-size:12px; line-height:1.2; }
    .hint{ margin-top:12px; color:var(--muted); font-size:13px; line-height:1.45; }
    .ok{ color:var(--good); font-weight:800; }
    .footer{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.35; }
    .sparkWrap{ margin-top:10px; padding:10px; border-radius:14px; background: rgba(255,255,255,.04); border:1px dashed rgba(255,255,255,.14); }
    .sparkHdr{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .warn{ color:#fb7185; font-weight:750; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="titleRow">
        <div>
          <h1 id="appName">T.I.M</h1>
          <p id="headline" class="sub"><span id="headlineStrong" class="ok">Tinnitus Is Manageable.</span> <span id="headlineRest">Press when you notice yourself reacting. Do the prompt, then carry on.</span></p>
        </div>
        <div id="tagline" class="tag">Private â€¢ Offline â€¢ No accounts</div>
      </div>

      <button id="bigButton" class="button" aria-label="Tap T.I.M">
        <span id="tapLabel">ğŸ”´ Tap T.I.M</span>
      </button>

      <div id="prompt" class="prompt">
        <span id="readyText">Ready. Tap when you notice a reaction (not every tiny moment).</span>
      </div>

      <div class="row">
        <label class="toggle pill" title="Speak the prompt out loud (may require a tap once first on mobile).">
          <input id="voiceToggle" type="checkbox" />
          ğŸ”Š Voice
        </label>

        <label class="toggle pill" title="A little more playful prompts (often helps reduce threat).">
          <input id="playfulToggle" type="checkbox" checked />
          ğŸ™‚ Playful
        </label>

        
        <label class="pill" style="display:flex;align-items:center;gap:8px" title="Language">
          ğŸŒ <span id="langLabel" style="color:var(--muted);font-size:13px;">Language</span>
          <select id="langSelect" aria-label="Language" style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);color:var(--text);border-radius:10px;padding:7px 8px;outline:none;">
            <option value="en">English</option>
            <option value="fr">FranÃ§ais</option>
            <option value="de">Deutsch</option>
            <option value="es">EspaÃ±ol</option>
            <option value="it">Italiano</option>
          </select>
        </label>

        <button id="newPrompt" class="smallbtn" type="button"><span id="newPromptLabel">New prompt</span></button>
        <button id="resetToday" class="smallbtn" type="button" title="Clears today's count only."><span id="resetTodayLabel">Reset today</span></button>
        <button id="clearAll" class="smallbtn" type="button" title="Clears all stored data on this device."><span id="clearAllLabel">Clear all</span></button>
      </div>

      <p class="hint">
        <span id="hintLine1">This is meant to support habituation â€” not create more monitoring.</span>
        <span id="hintLine2">Best practice: use it when you notice a <span class="warn">spiral / annoyance</span>, then return to life.</span>
      </p>

      <div class="footer">
        <span id="footerLine">Data stays on this device using <span class="mono">localStorage</span>. Nothing is uploaded anywhere.</span>
      </div>
    </section>

    <aside class="card">
      <h1 id="progressTitle">Progress</h1>
      <p id="progressSub" class="sub">Gentle stats. Try not to stare at them all day.</p>

      <div class="kpi">
        <div class="box">
          <p id="todayNum" class="num">0</p>
          <p id="lblToday" class="lbl">Taps today</p>
        </div>
        <div class="box">
          <p id="avg30Num" class="num">0</p>
          <p id="lblAvg" class="lbl">Average taps (last 30 days)</p>
        </div>
        <div class="box">
          <p id="daysUsedNum" class="num">0</p>
          <p id="lblDays" class="lbl">Days used (last 30 days)</p>
        </div>
        <div class="box">
          <p id="bestGapNum" class="num">â€”</p>
          <p id="lblGap" class="lbl">Longest â€œno tapâ€ gap today</p>
        </div>
      </div>

      <div class="sparkWrap">
        <div class="sparkHdr">
          <div id="sparkHdrLabel" class="sub" style="margin:0">Last 30 days (taps/day)</div>
          <div id="trendTxt" class="tag mono">trend: â€”</div>
        </div>
        <svg id="spark" viewBox="0 0 300 80" width="100%" height="80" aria-label="Last 30 days sparkline">
          <path id="sparkPath" d="" fill="none" stroke="rgba(255,255,255,.55)" stroke-width="2" />
          <path id="sparkBase" d="M0 79 H300" fill="none" stroke="rgba(255,255,255,.12)" stroke-width="1" />
        </svg>
        <div class="hint" style="margin-top:8px">
          <span id="sparkHint">Progress usually looks like: fewer â€œurgentâ€ taps, longer gaps, and less time thinking about it â€” even if the sound itself varies.</span>
        </div>
      </div>

      <div class="footer">
        <span id="progressFooter">If you want a daily â€œone lookâ€ routine: check stats once in the evening, not during the day.</span>
      </div>
    </aside>
  </div>


<script>
/* T.I.M â€” multi-language version (offline + localStorage)
   Languages: EN, FR, DE, ES, IT
*/
const I18N = {"en": {"ui": {"pageTitle": "T.I.M â€” Tinnitus Is Manageable", "headlineStrong": "Tinnitus Is Manageable.", "headlineRest": "Press when you notice yourself reacting. Do the prompt, then carry on.", "tagline": "Private â€¢ Offline â€¢ No accounts", "tapLabel": "ğŸ”´ Tap T.I.M", "readyText": "Ready. Tap when you notice a reaction (not every tiny moment).", "voice": "ğŸ”Š Voice", "playful": "ğŸ™‚ Playful", "newPrompt": "New prompt", "resetToday": "Reset today", "clearAll": "Clear all", "hint1": "This is meant to support habituation â€” not create more monitoring.", "hint2": "Best practice: use it when you notice a <span class=\"warn\">spiral / annoyance</span>, then return to life.", "footer": "Data stays on this device using <span class=\"mono\">localStorage</span>. Nothing is uploaded anywhere.", "progressTitle": "Progress", "progressSub": "Gentle stats. Try not to stare at them all day.", "lblToday": "Taps today", "lblAvg": "Average taps (last 30 days)", "lblDays": "Days used (last 30 days)", "lblGap": "Longest â€œno tapâ€ gap today", "sparkHdr": "Last 30 days (taps/day)", "sparkHint": "Progress usually looks like: fewer â€œurgentâ€ taps, longer gaps, and less time thinking about it â€” even if the sound itself varies.", "progressFooter": "If you want a daily â€œone lookâ€ routine: check stats once in the evening, not during the day.", "language": "Language"}, "prompts": {"core": ["Take one slow breath inâ€¦ and outâ€¦ (just once).", "Notice 3 things you can see. Name them quietly.", "Feel your feet. Press toes into the floor for 3 seconds.", "Count backwards from 20 to 12. Stop.", "Name 5 animals. Done.", "Name 4 foods. Done.", "Name 3 places youâ€™ve been. Done.", "Scan your shoulders. Drop them 1cm.", "Unclench your jaw. Tiny reset.", "Look for something rectangular. Find 2.", "Look for something round. Find 1.", "Pick a colour. Spot 3 of it in the room.", "Imagine drawing a perfect circle in the air â€” slowly.", "Picture a bicycle wheel turning exactly 5 times. Count each rotation.", "Tap your thumb to each finger once. (1â€“2â€“3â€“4).", "Count 7 sounds around you (not the tinnitus).", "Describe the room like youâ€™re narrating a documentary (one sentence).", "Choose a task youâ€™re already doing and do the next 30 seconds only.", "Relax your forehead. Smooth it like youâ€™re ironing a tiny shirt.", "Stretch your fingers wideâ€¦ then relax.", "Name 2 things youâ€™re grateful for today (small counts).", "Imagine a volume knob. Turn it down 10%â€¦ then walk away.", "Write (or think) one neutral sentence: â€œThis is a sound, not a threat.â€", "Pick an object. Notice its texture for 5 seconds.", "Take a sip of water. Focus on the temperature.", "Count 10 blinks. Yes, really.", "Think of a song chorus (just 2 lines) and play it once in your head.", "Visualise opening a door. Whatâ€™s behind it? One sentence.", "Pick a category (games, films, books). Name 5 quickly, then stop.", "Do a micro tidy: move one item to where it belongs.", "Send a kind text to someone (or draft it).", "Stand up. Sit down. Thatâ€™s it.", "Look outside (or at a window). Find the farthest thing you can see.", "Set a 60â€‘second timer and do nothing but your current activity.", "Smile slightly (fake is fine). Let your brain get the memo."], "playful": ["Imagine a tiny dragon doing 3 push-ups. Count them. ğŸ’ªğŸ‰", "Picture a duck wearing a tiny hat. What colour is the hat?", "Visualise a cat sneaking pastâ€¦ but itâ€™s wearing squeaky shoes.", "Imagine a goblin making tea. Which mug does it choose?", "Pretend youâ€™re a game master: describe this room as a dungeon tile.", "Your mission: locate the nearest â€˜treasureâ€™ (a pen). Do it.", "Imagine a wizard casting â€˜Mild Calmâ€™. The spell sparkles politely.", "Picture a knight arguing with a door. The door wins. Move on.", "Think of a polite orc saying â€œexcuse meâ€ and opening a jar.", "Imagine a squirrel doing taxes. Itâ€™s stressed. You donâ€™t have to be.", "Summon a mental soundtrack: â€˜Epicâ€¦ but for doing laundryâ€™.", "Imagine your tinnitus as a tiny radio in another room. Leave it there.", "Design a monster name: â€˜Sir Flaps-a-Lotâ€™. Done.", "Picture a dragon doing yoga. It is surprisingly flexible.", "Imagine a gnome DM (Fred) saying: â€œRoll for chill.â€ You pass.", "Visualise a snail with a jetpack. It is still a snail.", "Imagine your brain filing â€˜tinnitusâ€™ into the â€˜boringâ€™ folder. *click*", "Create a made-up spell: â€˜Ignore-ius Maximusâ€™. Cast it.", "Picture a penguin explaining Bluetooth. Confidently wrong.", "Imagine a hamster holding a tiny microphone: â€œNext question!â€", "Invent a new board game: â€˜Carpet: The Reckoningâ€™ (one sentence).", "Imagine a cactus giving a hug. It regrets it immediately.", "Picture a dragon doing push-ups again. Itâ€™s committed now.", "Imagine a gremlin polishing armour. It is doing its best.", "Think of a theme park ride called â€˜The Mild Distractionâ€™. Enjoy it.", "Picture a wizardâ€™s staffâ€¦ but itâ€™s actually a baguette.", "Imagine a tiny bard singing: â€œla la la, not today.â€", "Visualise a frog in a cape. It believes in you.", "Imagine a robot learning to wink. Itâ€™sâ€¦ unsettling.", "Picture a goblin writing a motivational poster: â€˜Keep Calm-ishâ€™.", "Imagine your thoughts as popcorn. Let one popâ€¦ then stop.", "Visualise a dragon doing one last push-up and retiring happily."], "follow": ["Nice. Now carry on without checking again.", "Good. Back to what you were doing.", "Done. Let it be there and continue.", "Great â€” attention outward again.", "Return to your activity."]}, "ttsLang": "en-GB"}, "fr": {"ui": {"pageTitle": "T.I.M â€” Les acouphÃ¨nes sont gÃ©rables", "headlineStrong": "Les acouphÃ¨nes sont gÃ©rables.", "headlineRest": "Appuie quand tu remarques une rÃ©action. Fais lâ€™exercice, puis continue.", "tagline": "PrivÃ© â€¢ Horsâ€‘ligne â€¢ Sans compte", "tapLabel": "ğŸ”´ Appuie sur T.I.M", "readyText": "PrÃªt. Appuie quand tu remarques une rÃ©action (pas Ã  chaque microâ€‘moment).", "voice": "ğŸ”Š Voix", "playful": "ğŸ™‚ DÃ©jantÃ©", "newPrompt": "Nouveau", "resetToday": "RÃ©initialiser aujourdâ€™hui", "clearAll": "Tout effacer", "hint1": "Le but est dâ€™aider lâ€™habituation â€” pas de surveiller davantage.", "hint2": "Conseil : utiliseâ€‘le quand tu sens une <span class=\"warn\">spirale / irritation</span>, puis reviens Ã  ta vie.", "footer": "Les donnÃ©es restent sur cet appareil via <span class=\"mono\">localStorage</span>. Rien nâ€™est envoyÃ©.", "progressTitle": "ProgrÃ¨s", "progressSub": "Stats douces. Ã‰vite de les regarder toute la journÃ©e.", "lblToday": "Appuis aujourdâ€™hui", "lblAvg": "Moyenne (30 derniers jours)", "lblDays": "Jours utilisÃ©s (30 jours)", "lblGap": "Plus longue pause sans appui aujourdâ€™hui", "sparkHdr": "30 derniers jours (appuis/jour)", "sparkHint": "Le progrÃ¨s ressemble souvent Ã  : moins dâ€™appuis â€œurgentsâ€, des pauses plus longues, et moins de temps Ã  y penser â€” mÃªme si le son varie.", "progressFooter": "Routine â€œun seul coup dâ€™Å“ilâ€ : regarde les stats une fois le soir, pas en journÃ©e.", "language": "Langue"}, "prompts": {"core": ["Une respiration lenteâ€¦ inspireâ€¦ expireâ€¦ (une seule).", "Regarde 3 choses. Nommeâ€‘les.", "Sens tes pieds. Pousse les orteils 3 secondes.", "Compte Ã  rebours de 20 Ã  12. Stop.", "Nomme 5 animaux. TerminÃ©.", "Nomme 4 aliments. TerminÃ©.", "Nomme 3 lieux oÃ¹ tu es allÃ©. TerminÃ©.", "Baisse les Ã©paules dâ€™1 cm.", "Desserre la mÃ¢choire. Mini reset.", "Trouve 2 choses rectangulaires.", "Trouve 1 chose ronde.", "Choisis une couleur. RepÃ¨reâ€‘en 3.", "Dessine un cercle parfait dans lâ€™air â€” lentement.", "Imagine une roue de vÃ©lo qui tourne 5 fois. Compte.", "Touche pouceâ€‘indexâ€‘majeurâ€‘annulaire (1â€“2â€“3â€“4).", "Compte 7 sons autour de toi (pas lâ€™acouphÃ¨ne).", "DÃ©cris la piÃ¨ce comme un documentaire (une phrase).", "Fais seulement les 30 prochaines secondes de ton activitÃ©.", "DÃ©tends le front. Comme si tu repassais une mini chemise.", "Ã‰carte les doigtsâ€¦ puis relÃ¢che.", "Deux petites gratitudes. Ã‡a compte.", "Imagine un bouton de volume. -10%â€¦ puis pars.", "Phrase neutre : Â« Câ€™est un son, pas une menace. Â»", "Choisis un objet. Sens sa texture 5 secondes.", "Bois une gorgÃ©e dâ€™eau. Sens la tempÃ©rature.", "Compte 10 clignements. Oui.", "Chante un refrain (2 lignes) dans ta tÃªte, une fois.", "Ouvre une porte imaginaire. Quâ€™y aâ€‘tâ€‘il derriÃ¨re ? Une phrase.", "CatÃ©gorie (jeux/films/livres) : 5 noms, puis stop.", "Microâ€‘rangement : replace un objet.", "Envoie un message gentil (ou Ã©crisâ€‘le).", "LÃ¨veâ€‘toi. Assiedsâ€‘toi. Câ€™est tout.", "Regarde au loin (fenÃªtre). Trouve la chose la plus lointaine.", "Minuteur 60 s : reviens juste Ã  ton activitÃ©.", "Petit sourire (mÃªme faux)."], "playful": ["Imagine un mini dragon qui fait 3 pompes. Compte. ğŸ’ªğŸ‰", "Un canard avec un chapeau. Quelle couleur ?", "Un chat furtifâ€¦ avec des chaussures qui couinent.", "Un gobelin fait du thÃ©. Quel mug choisitâ€‘il ?", "Mode MJ : dÃ©cris la piÃ¨ce comme une tuile de donjon.", "Mission : trouve un â€˜trÃ©sorâ€™ (un stylo). Go.", "Un mage lance Â« Calme LÃ©ger Â». Ã‡a scintille poliment.", "Un chevalier dispute avec une porte. La porte gagne. On avance.", "Un orc poli dit : Â« excusezâ€‘moi Â» et ouvre un bocal.", "Un Ã©cureuil fait ses impÃ´ts. Il stresse. Pas toi.", "Musique Ã©piqueâ€¦ pour plier du linge.", "Ton acouphÃ¨ne = une petite radio dans une autre piÃ¨ce. Laisseâ€‘la.", "Nom de monstre : Â« Sir Flapâ€‘aâ€‘Lot Â». Fin.", "Un dragon fait du yoga. TrÃ¨s souple.", "Fred le gnome dit : Â« Lance pour chill Â». Tu rÃ©ussis.", "Un escargot avec un jetpack. Toujours escargot.", "Ton cerveau classe â€˜acouphÃ¨nesâ€™ dans â€˜ennuyeuxâ€™. *clic*", "Sort inventÃ© : Â« Ignoreâ€‘ius Maximus Â». Lanceâ€‘le.", "Un pingouin explique le Bluetooth. TrÃ¨s sÃ»r. Faux.", "Un hamster au micro : Â« Question suivante ! Â»", "Nouveau jeu : Â« Tapis : La Revanche Â» (une phrase).", "Un cactus fait un cÃ¢lin. Il regrette.", "Le dragon refait des pompes. Il est motivÃ©.", "Un gremlin polit une armure. Il fait de son mieux.", "Attraction : Â« La Distraction Douce Â». Profite.", "Baguette magiqueâ€¦ littÃ©ralement une baguette.", "Un mini barde chante : Â« pas aujourdâ€™hui Â». ", "Une grenouille en cape. Elle croit en toi.", "Un robot apprend Ã  faire un clin dâ€™Å“il. Bizarre.", "Un gobelin Ã©crit : Â« Reste calm-ish Â». ", "Tes pensÃ©es = popcorn. Une popâ€¦ puis stop.", "Un dernier push-up du dragon, puis retraite heureuse."], "follow": ["Bien. Maintenant, continue sans reâ€‘checker.", "Parfait. Retour Ã  ce que tu faisais.", "Fini. Laisseâ€‘le lÃ  et avance.", "TrÃ¨s bien â€” attention vers lâ€™extÃ©rieur.", "Reviens Ã  ton activitÃ©."]}, "ttsLang": "fr-FR"}, "de": {"ui": {"pageTitle": "T.I.M â€” Tinnitus ist machbar", "headlineStrong": "Tinnitus ist machbar.", "headlineRest": "DrÃ¼ck, wenn du merkst, dass du reagierst. Mach den Impuls, dann weiter.", "tagline": "Privat â€¢ Offline â€¢ Keine Konten", "tapLabel": "ğŸ”´ T.I.M drÃ¼cken", "readyText": "Bereit. DrÃ¼ck, wenn du eine Reaktion bemerkst (nicht bei jedem Miniâ€‘Moment).", "voice": "ğŸ”Š Stimme", "playful": "ğŸ™‚ Albern", "newPrompt": "Neu", "resetToday": "Heute zurÃ¼cksetzen", "clearAll": "Alles lÃ¶schen", "hint1": "Das soll Habituation unterstÃ¼tzen â€” nicht mehr Ãœberwachung.", "hint2": "Tipp: Nutze es bei <span class=\"warn\">Spirale / Genervtsein</span>, dann zurÃ¼ck ins Leben.", "footer": "Daten bleiben auf diesem GerÃ¤t via <span class=\"mono\">localStorage</span>. Nichts wird hochgeladen.", "progressTitle": "Fortschritt", "progressSub": "Sanfte Stats. Nicht den ganzen Tag anstarren.", "lblToday": "Taps heute", "lblAvg": "Durchschnitt (letzte 30 Tage)", "lblDays": "Tage genutzt (30 Tage)", "lblGap": "LÃ¤ngste â€kein Tapâ€œ-Pause heute", "sparkHdr": "Letzte 30 Tage (Taps/Tag)", "sparkHint": "Fortschritt sieht oft so aus: weniger â€dringendeâ€œ Taps, lÃ¤ngere Pausen, weniger Zeit daran zu denken â€” auch wenn der Ton schwankt.", "progressFooter": "â€Ein Blick am Tagâ€œ: Stats abends einmal checken, nicht tagsÃ¼ber.", "language": "Sprache"}, "prompts": {"core": ["Einmal langsam einatmenâ€¦ ausatmenâ€¦ (nur einmal).", "Sieh 3 Dinge. Benenne sie.", "SpÃ¼r deine FÃ¼ÃŸe. Zehen 3 Sekunden in den Boden drÃ¼cken.", "RÃ¼ckwÃ¤rts zÃ¤hlen von 20 bis 12. Stopp.", "Nenne 5 Tiere. Fertig.", "Nenne 4 Essen. Fertig.", "Nenne 3 Orte, an denen du warst. Fertig.", "Schultern scannen. 1 cm fallen lassen.", "Kiefer lÃ¶sen. Miniâ€‘Reset.", "Finde 2 rechteckige Dinge.", "Finde 1 rundes Ding.", "WÃ¤hle eine Farbe. Entdecke 3 davon.", "Male einen perfekten Kreis in die Luft â€” langsam.", "Stell dir ein Fahrradâ€‘Rad vor: 5 Umdrehungen. ZÃ¤hlen.", "Daumen zu jedem Finger tippen (1â€“2â€“3â€“4).", "ZÃ¤hle 7 GerÃ¤usche um dich herum (nicht das Tinnitusâ€‘GerÃ¤usch).", "Beschreibe den Raum wie eine Doku (1 Satz).", "Mach nur die nÃ¤chsten 30 Sekunden deiner aktuellen Aufgabe.", "Stirn entspannen. Als wÃ¼rdest du ein Miniâ€‘Hemd bÃ¼geln.", "Finger spreizenâ€¦ dann lÃ¶sen.", "Nenne 2 kleine Dinge, fÃ¼r die du dankbar bist.", "Stell dir einen LautstÃ¤rkeâ€‘Regler vor. -10%â€¦ und weggehen.", "Neutraler Satz: â€Das ist ein GerÃ¤usch, keine Gefahr.â€œ", "Objekt wÃ¤hlen. Textur 5 Sekunden spÃ¼ren.", "Einen Schluck Wasser. Temperatur merken.", "10 Blinzler zÃ¤hlen. Ja.", "Refrain (2 Zeilen) einmal im Kopf abspielen.", "TÃ¼r im Kopf Ã¶ffnen. Was dahinter? 1 Satz.", "Kategorie (Spiele/Filme/BÃ¼cher): 5 Namen, dann Stopp.", "Miniâ€‘AufrÃ¤umen: Leg 1 Ding weg.", "Schicke eine nette Nachricht (oder entwirf sie).", "Aufstehen. Hinsetzen. Fertig.", "Raus schauen (Fenster). Finde das entfernteste Ding.", "60â€‘Sekundenâ€‘Timer: nur deine Aufgabe.", "Leicht lÃ¤cheln (fake ok)."], "playful": ["Stell dir einen Miniâ€‘Drachen vor, der 3 LiegestÃ¼tze macht. ZÃ¤hl. ğŸ’ªğŸ‰", "Eine Ente mit Miniâ€‘Hut. Welche Farbe?", "Eine Katze schleicht vorbeiâ€¦ in quietschenden Schuhen.", "Ein Goblin macht Tee. Welche Tasse nimmt er?", "Gameâ€‘Masterâ€‘Modus: Beschreibe den Raum als Dungeonâ€‘Tile.", "Mission: Finde den nÃ¤chsten â€Schatzâ€œ (einen Stift). Los.", "Ein Zauberer wirkt â€Milde Ruheâ€œ. Funkelt hÃ¶flich.", "Ein Ritter streitet mit einer TÃ¼r. Die TÃ¼r gewinnt. Weiter.", "Ein hÃ¶flicher Ork sagt â€entschuldigungâ€œ und Ã¶ffnet ein Glas.", "Ein EichhÃ¶rnchen macht Steuern. Es stresst. Du nicht.", "Epische Musikâ€¦ fÃ¼rs WÃ¤scheâ€‘Falten.", "Tinnitus = kleines Radio im Nebenraum. Lass es dort.", "Monstername: â€Sir Flapâ€‘aâ€‘Lotâ€œ. Fertig.", "Ein Drache macht Yoga. Ãœberraschend beweglich.", "Der Gnomâ€‘DM sagt: â€WÃ¼rfel auf Chill.â€œ Du schaffst es.", "Eine Schnecke mit Jetpack. Immer noch Schnecke.", "Gehirn sortiert â€šTinnitusâ€˜ in den Ordner â€šlangweiligâ€˜. *klick*", "Neuer Zauber: â€Ignorierâ€‘ius Maximusâ€œ. Wirken.", "Ein Pinguin erklÃ¤rt Bluetooth. Sehr sicher. Falsch.", "Ein Hamster am Mikro: â€NÃ¤chste Frage!â€œ", "Neues Brettspiel: â€Teppich: Die Abrechnungâ€œ (1 Satz).", "Ein Kaktus umarmt. Bereut sofort.", "Der Drache macht nochmal LiegestÃ¼tze. Verpflichtet jetzt.", "Ein Gremlin poliert RÃ¼stung. Er bemÃ¼ht sich.", "FahrgeschÃ¤ft: â€Die Milde Ablenkungâ€œ. GenieÃŸ es.", "Zauberstabâ€¦ ist eigentlich ein Baguette.", "Miniâ€‘Barde singt: â€nicht heuteâ€œ. ", "Ein Frosch mit Umhang. Er glaubt an dich.", "Ein Roboter lernt zwinkern. Unheimlich.", "Goblin schreibt Poster: â€Keep Calmâ€‘ishâ€œ. ", "Gedanken wie Popcorn: ein Popâ€¦ dann Stopp.", "Letzter LiegestÃ¼tz vom Drachen, dann Ruhestand."], "follow": ["Top. Jetzt weiter ohne nochmal zu checken.", "Gut. ZurÃ¼ck zu dem, was du getan hast.", "Erledigt. Lassen und weitergehen.", "Sehr gut â€” Aufmerksamkeit nach auÃŸen.", "ZurÃ¼ck zur AktivitÃ¤t."]}, "ttsLang": "de-DE"}, "es": {"ui": {"pageTitle": "T.I.M â€” El tinnitus es manejable", "headlineStrong": "El tinnitus es manejable.", "headlineRest": "Pulsa cuando notes que reaccionas. Haz el ejercicio y sigue.", "tagline": "Privado â€¢ Sin conexiÃ³n â€¢ Sin cuentas", "tapLabel": "ğŸ”´ Pulsa T.I.M", "readyText": "Listo. Pulsa cuando notes una reacciÃ³n (no en cada microâ€‘momento).", "voice": "ğŸ”Š Voz", "playful": "ğŸ™‚ Travieso", "newPrompt": "Nuevo", "resetToday": "Reiniciar hoy", "clearAll": "Borrar todo", "hint1": "Esto ayuda a la habituaciÃ³n â€” no a vigilar mÃ¡s.", "hint2": "Consejo: Ãºsalo cuando notes una <span class=\"warn\">espiral / molestia</span>, y vuelve a tu vida.", "footer": "Los datos se quedan en este dispositivo con <span class=\"mono\">localStorage</span>. No se sube nada.", "progressTitle": "Progreso", "progressSub": "EstadÃ­sticas suaves. No las mires todo el dÃ­a.", "lblToday": "Pulsaciones hoy", "lblAvg": "Promedio (Ãºltimos 30 dÃ­as)", "lblDays": "DÃ­as usado (30 dÃ­as)", "lblGap": "Mayor pausa sin pulsar hoy", "sparkHdr": "Ãšltimos 30 dÃ­as (puls./dÃ­a)", "sparkHint": "El progreso suele verse asÃ­: menos pulsaciones â€œurgentesâ€, pausas mÃ¡s largas y menos tiempo pensando en ello â€” aunque el sonido varÃ­e.", "progressFooter": "Rutina de â€œuna miradaâ€: mira las stats una vez por la noche, no durante el dÃ­a.", "language": "Idioma"}, "prompts": {"core": ["Una respiraciÃ³n lentaâ€¦ inhalaâ€¦ exhalaâ€¦ (solo una).", "Mira 3 cosas. NÃ³mbralas.", "Siente los pies. Presiona los dedos 3 segundos.", "Cuenta hacia atrÃ¡s de 20 a 12. Para.", "Nombra 5 animales. Hecho.", "Nombra 4 comidas. Hecho.", "Nombra 3 lugares donde has estado. Hecho.", "Escanea hombros. BÃ¡jalos 1 cm.", "Relaja la mandÃ­bula. Mini reinicio.", "Encuentra 2 cosas rectangulares.", "Encuentra 1 cosa redonda.", "Elige un color. Localiza 3.", "Dibuja un cÃ­rculo perfecto en el aire â€” despacio.", "Imagina una rueda de bici girando 5 veces. Cuenta.", "Pulgar a cada dedo una vez (1â€“2â€“3â€“4).", "Cuenta 7 sonidos alrededor (no el tinnitus).", "Describe la habitaciÃ³n como documental (1 frase).", "Haz solo los prÃ³ximos 30 segundos de tu actividad.", "Relaja la frente. Como planchar una mini camisa.", "Estira los dedosâ€¦ y suelta.", "Piensa en 2 gratitudes pequeÃ±as.", "Imagina un mando de volumen. -10%â€¦ y alÃ©jate.", "Frase neutral: Â«Es un sonido, no una amenazaÂ».", "Elige un objeto. Nota su textura 5 segundos.", "Bebe un sorbo de agua. Nota la temperatura.", "Cuenta 10 parpadeos. SÃ­.", "Tararea un estribillo (2 lÃ­neas) una vez.", "Abre una puerta imaginaria. Â¿QuÃ© hay? 1 frase.", "CategorÃ­a (juegos/pelis/libros): 5 nombres y stop.", "Microâ€‘orden: coloca 1 cosa en su sitio.", "EnvÃ­a un mensaje amable (o bÃ³rrador).", "LevÃ¡ntate. SiÃ©ntate. Ya.", "Mira lejos (ventana). Encuentra lo mÃ¡s lejano.", "Temporizador 60 s: solo tu tarea.", "SonrÃ­e un poco (falso vale)."], "playful": ["Imagina un mini dragÃ³n haciendo 3 flexiones. Cuenta. ğŸ’ªğŸ‰", "Un pato con sombrerito. Â¿De quÃ© color?", "Un gato sigilosoâ€¦ con zapatos que chirrÃ­an.", "Un duende prepara tÃ©. Â¿QuÃ© taza elige?", "Modo mÃ¡ster: describe la sala como loseta de mazmorra.", "MisiÃ³n: encuentra un â€˜tesoroâ€™ (un boli).", "Un mago lanza Â«Calma SuaveÂ». Brilla educadamente.", "Un caballero discute con una puerta. La puerta gana. Sigue.", "Un orco educado dice â€œperdÃ³nâ€ y abre un frasco.", "Una ardilla hace impuestos. Se estresa. TÃº no.", "MÃºsica Ã©picaâ€¦ para doblar ropa.", "El tinnitus = una radio en otra habitaciÃ³n. DÃ©jala allÃ­.", "Nombre de monstruo: Â«Sir Aleteaâ€‘MuchoÂ». Hecho.", "Un dragÃ³n hace yoga. Sorprendentemente flexible.", "El gnomo DM dice: Â«Tira para chillÂ». Aprobado.", "Un caracol con jetpack. Sigue siendo caracol.", "Tu cerebro archiva â€˜tinnitusâ€™ en â€˜aburridoâ€™. *clic*", "Hechizo inventado: Â«Ignoraâ€‘ius MÃ¡ximusÂ».", "Un pingÃ¼ino explica Bluetooth. Muy seguro. Mal.", "Un hÃ¡mster al micro: Â«Â¡Siguiente pregunta!Â»", "Nuevo juego: Â«Alfombra: El Ajuste de CuentasÂ» (1 frase).", "Un cactus da un abrazo. Se arrepiente.", "El dragÃ³n hace otra flexiÃ³n. Comprometido.", "Un gremlin pule armadura. Hace lo que puede.", "AtracciÃ³n: Â«La DistracciÃ³n SuaveÂ». Disfruta.", "Varita mÃ¡gicaâ€¦ es una baguette.", "Un mini bardo canta: â€œhoy noâ€.", "Una rana con capa. Cree en ti.", "Un robot aprende a guiÃ±ar. Inquietante.", "Un duende escribe pÃ³ster: â€œKeep Calmâ€‘ishâ€.", "Pensamientos como palomitas: popâ€¦ y stop.", "Ãšltima flexiÃ³n del dragÃ³n y se jubila feliz."], "follow": ["Bien. Ahora sigue sin comprobar.", "Genial. Vuelve a lo que hacÃ­as.", "Listo. DÃ©jalo estar y continÃºa.", "Perfecto â€” atenciÃ³n hacia fuera.", "Vuelve a tu actividad."]}, "ttsLang": "es-ES"}, "it": {"ui": {"pageTitle": "T.I.M â€” Lâ€™acufene Ã¨ gestibile", "headlineStrong": "Lâ€™acufene Ã¨ gestibile.", "headlineRest": "Premi quando noti una reazione. Fai il prompt e poi continua.", "tagline": "Privato â€¢ Offline â€¢ Nessun account", "tapLabel": "ğŸ”´ Premi T.I.M", "readyText": "Pronto. Premi quando noti una reazione (non ogni microâ€‘momento).", "voice": "ğŸ”Š Voce", "playful": "ğŸ™‚ Strambo", "newPrompt": "Nuovo", "resetToday": "Reset oggi", "clearAll": "Cancella tutto", "hint1": "Serve a sostenere lâ€™abituazione â€” non a controllare di piÃ¹.", "hint2": "Consiglio: usalo quando senti una <span class=\"warn\">spirale / fastidio</span>, poi torna alla vita.", "footer": "I dati restano su questo dispositivo con <span class=\"mono\">localStorage</span>. Nulla viene caricato.", "progressTitle": "Progresso", "progressSub": "Statistiche leggere. Non fissarle tutto il giorno.", "lblToday": "Tap oggi", "lblAvg": "Media (ultimi 30 giorni)", "lblDays": "Giorni usato (30 giorni)", "lblGap": "Pausa piÃ¹ lunga senza tap oggi", "sparkHdr": "Ultimi 30 giorni (tap/giorno)", "sparkHint": "Il progresso spesso Ã¨: meno tap â€œurgentiâ€, pause piÃ¹ lunghe e meno tempo a pensarci â€” anche se il suono varia.", "progressFooter": "Routine â€œunâ€™occhiataâ€: controlla le stats una volta la sera, non durante il giorno.", "language": "Lingua"}, "prompts": {"core": ["Un respiro lentoâ€¦ inspiraâ€¦ espiraâ€¦ (solo uno).", "Guarda 3 cose. Nominale.", "Senti i piedi. Premi le dita 3 secondi.", "Conta allâ€™indietro da 20 a 12. Stop.", "Nomina 5 animali. Fatto.", "Nomina 4 cibi. Fatto.", "Nomina 3 posti dove sei stato. Fatto.", "Scansiona le spalle. Abbassale di 1 cm.", "Rilassa la mascella. Mini reset.", "Trova 2 cose rettangolari.", "Trova 1 cosa rotonda.", "Scegli un colore. Trova 3 oggetti.", "Disegna un cerchio perfetto nellâ€™aria â€” lentamente.", "Immagina una ruota di bici: 5 giri. Conta.", "Pollice su ogni dito una volta (1â€“2â€“3â€“4).", "Conta 7 suoni intorno (non lâ€™acufene).", "Descrivi la stanza come un documentario (1 frase).", "Fai solo i prossimi 30 secondi della tua attivitÃ .", "Rilassa la fronte. Come stirare una mini camicia.", "Allarga le ditaâ€¦ poi rilassa.", "Due piccole gratitudini. Valgono.", "Immagina una manopola volume. -10%â€¦ e via.", "Frase neutra: Â«Ãˆ un suono, non una minacciaÂ».", "Scegli un oggetto. Nota la texture 5 secondi.", "Un sorso dâ€™acqua. Nota la temperatura.", "Conta 10 battiti di ciglia. SÃ¬.", "Ripeti un ritornello (2 righe) una volta nella testa.", "Apri una porta immaginaria. Cosa câ€™Ã¨? 1 frase.", "Categoria (giochi/film/libri): 5 nomi e stop.", "Micro riordino: rimetti a posto 1 cosa.", "Invia un messaggio gentile (o bozza).", "Alzati. Siediti. Fine.", "Guarda lontano (finestra). Trova la cosa piÃ¹ distante.", "Timer 60 s: solo la tua attivitÃ .", "Sorriso leggero (anche finto va bene)."], "playful": ["Immagina un mini drago che fa 3 flessioni. Conta. ğŸ’ªğŸ‰", "Unâ€™anatra con un cappellino. Di che colore?", "Un gatto furtivoâ€¦ con scarpe che cigolano.", "Un goblin prepara il tÃ¨. Quale tazza sceglie?", "ModalitÃ  master: descrivi la stanza come una tessera dungeon.", "Missione: trova un â€˜tesoroâ€™ (una penna).", "Un mago lancia Â«Calma LeggeraÂ». Scintilla educatamente.", "Un cavaliere litiga con una porta. La porta vince. Avanti.", "Un orco educato dice â€œscusaâ€ e apre un barattolo.", "Uno scoiattolo fa le tasse. Si stressa. Tu no.", "Colonna sonora epicaâ€¦ per piegare i panni.", "Lâ€™acufene = una radio in unâ€™altra stanza. Lasciala lÃ¬.", "Nome mostro: Â«Sir Sbatacchiaâ€‘MoltoÂ». Fatto.", "Un drago fa yoga. Sorprendentemente flessibile.", "Il DM gnomo dice: Â«Tira per chillÂ». Superato.", "Una lumaca con jetpack. Sempre lumaca.", "Il cervello archivia â€˜acufeneâ€™ in â€˜noiosoâ€™. *click*", "Incantesimo inventato: Â«Ignoraâ€‘ius MaximusÂ».", "Un pinguino spiega il Bluetooth. Sicuro. Sbagliato.", "Un criceto al micro: Â«Prossima domanda!Â»", "Nuovo gioco: Â«Tappeto: La Resa dei ContiÂ» (1 frase).", "Un cactus dÃ  un abbraccio. Si pente.", "Il drago fa unâ€™altra flessione. Ormai Ã¨ convinto.", "Un gremlin lucida unâ€™armatura. Ce la mette tutta.", "Giostra: Â«La Distrazione GentileÂ». Enjoy.", "Bacchetta magicaâ€¦ Ã¨ una baguette.", "Un mini bardo canta: â€œnon oggiâ€.", "Una rana con mantello. Crede in te.", "Un robot impara a strizzare lâ€™occhio. Inquietante.", "Un goblin scrive poster: â€œKeep Calmâ€‘ishâ€.", "Pensieri come popcorn: popâ€¦ e stop.", "Ultima flessione del drago e pensione felice."], "follow": ["Bene. Ora continua senza ricontrollare.", "Ottimo. Torna a quello che stavi facendo.", "Fatto. Lascialo lÃ¬ e continua.", "Perfetto â€” attenzione fuori.", "Torna alla tua attivitÃ ."]}, "ttsLang": "it-IT"}};

const KEY = "tim_tinnitus_is_manageable_v3";

function storageAvailable(){
  try{
    const k="__tim_test__";
    localStorage.setItem(k,"1");
    localStorage.removeItem(k);
    return true;
  }catch(e){
    return false;
  }
}

function showStorageWarning(lang){
  const ui = (I18N[lang] && I18N[lang].ui) ? I18N[lang].ui : I18N.en.ui;
  if(storageAvailable()) return;
  let el = document.getElementById("storageWarn");
  if(!el){
    el = document.createElement("div");
    el.id = "storageWarn";
    el.style.marginTop = "10px";
    el.style.padding = "10px 12px";
    el.style.border = "1px solid rgba(255,255,255,.18)";
    el.style.borderRadius = "12px";
    el.style.background = "rgba(255, 145, 0, .08)";
    el.style.color = "var(--text)";
    el.style.fontSize = "13px";
    el.innerHTML = "âš ï¸ Storage is blocked in this browser mode, so stats canâ€™t be saved. Try a normal (nonâ€‘private) tab or another browser.";
    // Put it under the big prompt card
    const anchor = document.getElementById("prompt")?.parentElement;
    (anchor || document.body).appendChild(el);
  }
}
function loadState(){ try { return JSON.parse(localStorage.getItem(KEY)) || {}; } catch { return {}; } }
function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

function ymd(d){
  const yy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}
function getToday(){ return ymd(new Date()); }

function ensureDay(state, dayKey){
  if(!state.days) state.days = {};
  if(!state.days[dayKey]) state.days[dayKey] = { taps:0, firstTapAt:null, lastTapAt:null, longestGapMs:0 };
  return state.days[dayKey];
}

function lastNDaysKeys(n){
  const keys = [];
  const base = new Date();
  for(let i=n-1; i>=0; i--){
    const d = new Date(base);
    d.setDate(base.getDate()-i);
    keys.push(ymd(d));
  }
  return keys;
}

function msToNice(ms){
  if(!ms || ms < 1000) return "â€”";
  const mins = Math.floor(ms/60000);
  const hrs = Math.floor(mins/60);
  const rMins = mins % 60;
  if(hrs <= 0) return mins + "m";
  return hrs + "h " + rMins + "m";
}

function getLang(){
  const s = loadState();
  const lang = (s.lang && I18N[s.lang]) ? s.lang : "en";
  return lang;
}
function setLang(lang){
  const s = loadState();
  s.lang = (I18N[lang] ? lang : "en");
  saveState(s);
}

function pickPrompt(lang, playfulOn){
  const pack = I18N[lang] || I18N.en;
  const core = pack.prompts.core;
  const playful = pack.prompts.playful;
  const follow = pack.prompts.follow;

  const bank = playfulOn ? core.concat(playful) : core.slice();
  const main = bank[Math.floor(Math.random()*bank.length)];
  const tail = follow[Math.floor(Math.random()*follow.length)];
  return main + " " + tail;
}

function speak(text, lang){
  if(!("speechSynthesis" in window)) return;
  try {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1.0; u.pitch = 1.0;
    u.lang = (I18N[lang] && I18N[lang].ttsLang) ? I18N[lang].ttsLang : "en-GB";
    window.speechSynthesis.speak(u);
  } catch(e){ /* ignore */ }
}

function recordTap(){
  const state = loadState();
  const t = getToday();
  const day = ensureDay(state, t);
  const now = Date.now();

  day.taps = (day.taps || 0) + 1;
  if(!day.firstTapAt) day.firstTapAt = now;
  if(day.lastTapAt){
    const gap = now - day.lastTapAt;
    if(gap > (day.longestGapMs || 0)) day.longestGapMs = gap;
  }
  day.lastTapAt = now;

  saveState(state);
}

function computeStats(){
  const state = loadState();
  const todayKey = getToday();
  const today = ensureDay(state, todayKey);

  const keys30 = lastNDaysKeys(30);
  const vals = keys30.map(k => (state.days && state.days[k] ? (state.days[k].taps||0) : 0));

  const total = vals.reduce((a,b)=>a+b,0);
  const daysUsed = vals.filter(v => v>0).length;
  const avg = total / 30;

  const last7 = vals.slice(23).reduce((a,b)=>a+b,0) / 7;
  const prev7 = vals.slice(16,23).reduce((a,b)=>a+b,0) / 7;
  let trend = "â€”";
  if(prev7 > 0 || last7 > 0){
    const delta = last7 - prev7;
    const sign = delta > 0 ? "+" : "";
    trend = `${sign}${delta.toFixed(1)} /day`;
  }

  saveState(state);
  return { today: today.taps||0, bestGapMs: today.longestGapMs||0, avg30: avg, daysUsed, vals, trend };
}

function renderSpark(vals){
  const w = 300, h = 80, pad = 6;
  const max = Math.max(1, ...vals);
  const min = 0;
  const dx = (w - pad*2) / (vals.length - 1);
  const pts = vals.map((v,i)=>{
    const x = pad + i*dx;
    const y = (h - pad) - ((v - min) / (max - min)) * (h - pad*2);
    return [x,y];
  });
  let d = "";
  pts.forEach((p,i)=>{ d += (i===0 ? "M" : " L") + p[0].toFixed(2) + " " + p[1].toFixed(2); });
  document.getElementById("sparkPath").setAttribute("d", d);
}

function applyUI(lang){
  const ui = (I18N[lang] && I18N[lang].ui) ? I18N[lang].ui : I18N.en.ui;

  document.documentElement.setAttribute("lang", lang);

  // Titles / headers
  const pageTitleEl = document.getElementById("pageTitle");
  if(pageTitleEl) pageTitleEl.textContent = ui.pageTitle;

  const strongEl = document.getElementById("headlineStrong");
  if(strongEl) strongEl.textContent = ui.headlineStrong;

  const restEl = document.getElementById("headlineRest");
  if(restEl) restEl.textContent = ui.headlineRest;

  const taglineEl = document.getElementById("tagline");
  if(taglineEl) taglineEl.textContent = ui.tagline;

  const tapEl = document.getElementById("tapLabel");
  if(tapEl) tapEl.textContent = ui.tapLabel;

  const readyEl = document.getElementById("readyText");
  if(readyEl) readyEl.textContent = ui.readyText;

  // Buttons
  const newPromptLabelEl = document.getElementById("newPromptLabel");
  if(newPromptLabelEl) newPromptLabelEl.textContent = ui.newPrompt;

  const resetTodayLabelEl = document.getElementById("resetTodayLabel");
  if(resetTodayLabelEl) resetTodayLabelEl.textContent = ui.resetToday;

  const clearAllLabelEl = document.getElementById("clearAllLabel");
  if(clearAllLabelEl) clearAllLabelEl.textContent = ui.clearAll;

  const langLabelEl = document.getElementById("langLabel");
  if(langLabelEl) langLabelEl.textContent = ui.language;

  // Voice + Playful pill labels (attach to the label that wraps the checkbox)
  const voiceCb = document.getElementById("voiceToggle");
  if(voiceCb && voiceCb.parentElement){
    const lbl = voiceCb.closest("label");
    if(lbl){
      // Keep the checkbox as-is, replace the trailing text with a span
      let span = lbl.querySelector(".pillTextVoice");
      if(!span){
        span = document.createElement("span");
        span.className = "pillTextVoice";
        span.style.color = "var(--muted)";
        span.style.fontSize = "13px";
        lbl.appendChild(span);
      }
      span.textContent = ui.voice;
      // Remove any old raw text nodes (e.g., " Voice")
      [...lbl.childNodes].forEach(n=>{
        if(n.nodeType===3 && n.textContent.trim().length) n.textContent = " ";
      });
    }
  }

  const playCb = document.getElementById("playfulToggle");
  if(playCb && playCb.parentElement){
    const lbl = playCb.closest("label");
    if(lbl){
      let span = lbl.querySelector(".pillTextPlay");
      if(!span){
        span = document.createElement("span");
        span.className = "pillTextPlay";
        span.style.color = "var(--muted)";
        span.style.fontSize = "13px";
        lbl.appendChild(span);
      }
      span.textContent = ui.playful;
      [...lbl.childNodes].forEach(n=>{
        if(n.nodeType===3 && n.textContent.trim().length) n.textContent = " ";
      });
    }
  }

  // Hints / footers
  const hint1El = document.getElementById("hintLine1");
  if(hint1El) hint1El.textContent = ui.hint1;

  const hint2El = document.getElementById("hintLine2");
  if(hint2El) hint2El.innerHTML = ui.hint2;

  const footerEl = document.getElementById("footerLine");
  if(footerEl) footerEl.innerHTML = ui.footer;

  // Progress panel
  const progressTitleEl = document.getElementById("progressTitle");
  if(progressTitleEl) progressTitleEl.textContent = ui.progressTitle;

  const progressSubEl = document.getElementById("progressSub");
  if(progressSubEl) progressSubEl.textContent = ui.progressSub;

  const lblTodayEl = document.getElementById("lblToday");
  if(lblTodayEl) lblTodayEl.textContent = ui.lblToday;

  const lblAvgEl = document.getElementById("lblAvg");
  if(lblAvgEl) lblAvgEl.textContent = ui.lblAvg;

  const lblDaysEl = document.getElementById("lblDays");
  if(lblDaysEl) lblDaysEl.textContent = ui.lblDays;

  const lblGapEl = document.getElementById("lblGap");
  if(lblGapEl) lblGapEl.textContent = ui.lblGap;

  const sparkHdrEl = document.getElementById("sparkHdrLabel");
  if(sparkHdrEl) sparkHdrEl.textContent = ui.sparkHdr;

  const sparkHintEl = document.getElementById("sparkHint");
  if(sparkHintEl) sparkHintEl.textContent = ui.sparkHint;

  const progressFooterEl = document.getElementById("progressFooter");
  if(progressFooterEl) progressFooterEl.textContent = ui.progressFooter;
}

function renderAll(){
  const lang = getLang();
  applyUI(lang);

  const s = computeStats();
  document.getElementById("todayNum").textContent = s.today;
  document.getElementById("avg30Num").textContent = s.avg30.toFixed(1);
  document.getElementById("daysUsedNum").textContent = s.daysUsed;
  document.getElementById("bestGapNum").textContent = msToNice(s.bestGapMs);
  document.getElementById("trendTxt").textContent = "trend: " + s.trend;
  renderSpark(s.vals);
}

const voiceToggle = document.getElementById("voiceToggle");
const playfulToggle = document.getElementById("playfulToggle");
const elPrompt = document.getElementById("prompt");
const langSelect = document.getElementById("langSelect");

function setPrompt(text){ elPrompt.textContent = text; }

document.getElementById("bigButton").addEventListener("click", () => {
  recordTap();
  const lang = getLang();
  const text = pickPrompt(lang, playfulToggle.checked);
  setPrompt(text);
  if(voiceToggle.checked) speak(text, lang);
  renderAll();
});

document.getElementById("newPrompt").addEventListener("click", () => {
  const lang = getLang();
  const text = pickPrompt(lang, playfulToggle.checked);
  setPrompt(text);
  if(voiceToggle.checked) speak(text, lang);
});

document.getElementById("resetToday").addEventListener("click", () => {
  const state = loadState();
  const t = getToday();
  if(state.days && state.days[t]) state.days[t] = { taps:0, firstTapAt:null, lastTapAt:null, longestGapMs:0 };
  saveState(state);
  const ui = I18N[getLang()].ui || I18N.en.ui;
  setPrompt(ui.readyText);
  renderAll();
});

document.getElementById("clearAll").addEventListener("click", () => {
  const ok = confirm("Are you sure? This will permanently reset all your T.I.M stats on this device.");
  if(!ok) return;

  localStorage.removeItem(KEY);
  const lang = "en";
  setLang(lang);
  if(langSelect) langSelect.value = lang;
  const ui = I18N[lang].ui;
  setPrompt(ui.readyText);
  renderAll();
});
if(langSelect){
  const cur = getLang();
  langSelect.value = cur;
  langSelect.addEventListener("change", (e) => {
    const next = e.target.value;
    setLang(next);
    showStorageWarning(next);
    const text = pickPrompt(next, playfulToggle.checked);
    setPrompt(text);
    if(voiceToggle.checked) speak(text, next);
    renderAll();
  });
}

// First render
showStorageWarning(getLang());
renderAll();
</script>
</body>
